#include <stdio.h>
#include <stdlib.h>  // For rand()

#define AUDIO_BASE 0xFF203040   // Audio core base address
#define PS2_BASE 0xFF200100     // PS2 keyboard base address
#define TIMER_BASE 0xFF202000   // Timer base address
#define HEX3_HEX0_BASE 0xFF200020  // HEX display base addresses
#define HEX5_HEX4_BASE 0xFF200030

#define TABLE_SIZE 1028          // 正弦波查找表大小
#define MAX_AMPLITUDE 0x7FFFFF  // 24-bit 最大振幅

// PS2 keyboard scan codes
#define PS2_KEY_SPACE 0x29      // Space key scan code
#define PS2_KEY_UP    0x75      // Up arrow scan code
#define PS2_KEY_DOWN  0x72      // Down arrow scan code

// 定义音频控制结构体
struct audio_t {
    volatile unsigned int control;
    volatile unsigned char rarc;
    volatile unsigned char ralc;
    volatile unsigned char wsrc;
    volatile unsigned char wslc;
    volatile unsigned int ldata;
    volatile unsigned int rdata;
};

// 定义计时器结构体
struct timer_t {
    volatile unsigned int status;
    volatile unsigned int control;
    volatile unsigned int periodl;
    volatile unsigned int periodh;
    volatile unsigned int snapl;
    volatile unsigned int snaph;
};

// 正弦波查找表
const int sine_table[TABLE_SIZE] = {
    7161809, 7205582, 7249353, 7293122, 7336885, 7380642, 7424390, 7468129, 7511856, 7555570, 7599270, 7642953, 7686618, 7730264,
    7773888, 7817489, 7861066, 7904617, 7948140, 7991634, 8035097, 8078527, 8121923, 8165283, 8208605, 8251889, 8295131, 8338332,
    8381488, 8424599, 8467662, 8510677, 8553642, 8596554, 8639413, 8682217, 8724964, 8767652, 8810281, 8852847, 8895351, 8937790,
    8980163, 9022468, 9064703, 9106867, 9148958, 9190976, 9232917, 9274781, 9316566, 9358271, 9399893, 9441432, 9482886, 9524253,
    9565532, 9606721, 9647819, 9688824, 9729734, 9770548, 9811265, 9851884, 9892401, 9932817, 9973129, 10013336, 10053436, 10093429,
    10133312, 10173084, 10212743, 10252289, 10291719, 10331032, 10370227, 10409301, 10448255, 10487086, 10525792, 10564373, 10602827, 10641152,
    10679347, 10717411, 10755342, 10793139, 10830800, 10868324, 10905710, 10942956, 10980060, 11017022, 11053840, 11090512, 11127038, 11163415,
    11199643, 11235721, 11271646, 11307417, 11343034, 11378494, 11413797, 11448941, 11483925, 11518748, 11553407, 11587903, 11622233, 11656397,
    11690393, 11724219, 11757875, 11791360, 11824671, 11857808, 11890770, 11923556, 11956163, 11988591, 12020839, 12052905, 12084789, 12116489,
    12148004, 12179332, 12210473, 12241425, 12272188, 12302760, 12333139, 12363326, 12393318, 12423115, 12452715, 12482117, 12511321, 12540325,
    12569128, 12597729, 12626127, 12654321, 12682309, 12710092, 12737667, 12765034, 12792191, 12819138, 12845874, 12872397, 12898708, 12924803,
    12950684, 12976348, 13001795, 13027024, 13052034, 13076824, 13101393, 13125740, 13149864, 13173764, 13197440, 13220890, 13244114, 13267111,
    13289880, 13312420, 13334730, 13356809, 13378657, 13400273, 13421656, 13442804, 13463719, 13484397, 13504840, 13525046, 13545014, 13564743,
    13584233, 13603484, 13622493, 13641262, 13659788, 13678072, 13696112, 13713908, 13731459, 13748765, 13765825, 13782638, 13799204, 13815521,
    13831591, 13847411, 13862981, 13878301, 13893370, 13908188, 13922753, 13937066, 13951126, 13964932, 13978484, 13991782, 14004824, 14017611,
    14030141, 14042415, 14054432, 14066192, 14077693, 14088937, 14099921, 14110646, 14121112, 14131318, 14141263, 14150947, 14160371, 14169533,
    14178433, 14187071, 14195447, 14203560, 14211410, 14218996, 14226319, 14233378, 14240173, 14246703, 14252969, 14258970, 14264705, 14270176,
    14275380, 14280319, 14284993, 14289400, 14293540, 14297415, 14301022, 14304363, 14307438, 14310245, 14312785, 14315058, 14317064, 14318803,
    14320274, 14321478, 14322414, 14323083, 14323484, 14323618, 14323484, 14323083, 14322414, 14321478, 14320274, 14318803, 14317064, 14315058,
    14312785, 14310245, 14307438, 14304363, 14301022, 14297415, 14293540, 14289400, 14284993, 14280319, 14275380, 14270176, 14264705, 14258970,
    14252969, 14246703, 14240173, 14233378, 14226319, 14218996, 14211410, 14203560, 14195447, 14187071, 14178433, 14169533, 14160371, 14150947,
    14141263, 14131318, 14121112, 14110646, 14099921, 14088937, 14077693, 14066192, 14054432, 14042415, 14030141, 14017611, 14004824, 13991782,
    13978484, 13964932, 13951126, 13937066, 13922753, 13908188, 13893370, 13878301, 13862981, 13847411, 13831591, 13815521, 13799204, 13782638,
    13765825, 13748765, 13731459, 13713908, 13696112, 13678072, 13659788, 13641262, 13622493, 13603484, 13584233, 13564743, 13545014, 13525046,
    13504840, 13484397, 13463719, 13442804, 13421656, 13400273, 13378657, 13356809, 13334730, 13312420, 13289880, 13267111, 13244114, 13220890,
    13197440, 13173764, 13149864, 13125740, 13101393, 13076824, 13052034, 13027024, 13001795, 12976348, 12950684, 12924803, 12898708, 12872397,
    12845874, 12819138, 12792191, 12765034, 12737667, 12710092, 12682309, 12654321, 12626127, 12597729, 12569128, 12540325, 12511321, 12482117,
    12452715, 12423115, 12393318, 12363326, 12333139, 12302760, 12272188, 12241425, 12210473, 12179332, 12148004, 12116489, 12084789, 12052905,
    12020839, 11988591, 11956163, 11923556, 11890770, 11857808, 11824671, 11791360, 11757875, 11724219, 11690393, 11656397, 11622233, 11587903,
    11553407, 11518748, 11483925, 11448941, 11413797, 11378494, 11343034, 11307417, 11271646, 11235721, 11199643, 11163415, 11127038, 11090512,
    11053840, 11017022, 10980060, 10942956, 10905710, 10868324, 10830800, 10793139, 10755342, 10717411, 10679347, 10641152, 10602827, 10564373,
    10525792, 10487086, 10448255, 10409301, 10370227, 10331032, 10291719, 10252289, 10212743, 10173084, 10133312, 10093429, 10053436, 10013336,
    9973129, 9932817, 9892401, 9851884, 9811265, 9770548, 9729734, 9688824, 9647819, 9606721, 9565532, 9524253, 9482886, 9441432,
    9399893, 9358271, 9316566, 9274781, 9232917, 9190976, 9148958, 9106867, 9064703, 9022468, 8980163, 8937790, 8895351, 8852847,
    8810281, 8767652, 8724964, 8682217, 8639413, 8596554, 8553642, 8510677, 8467662, 8424599, 8381488, 8338332, 8295131, 8251889,
    8208605, 8165283, 8121923, 8078527, 8035097, 7991634, 7948140, 7904617, 7861066, 7817489, 7773888, 7730264, 7686618, 7642953,
    7599270, 7555570, 7511856, 7468129, 7424390, 7380642, 7336885, 7293122, 7249353, 7205582, 7161809, 7118036, 7074265, 7030496,
    6986733, 6942976, 6899228, 6855489, 6811762, 6768048, 6724348, 6680665, 6637000, 6593354, 6549730, 6506129, 6462552, 6419001,
    6375478, 6331984, 6288521, 6245091, 6201695, 6158335, 6115013, 6071729, 6028487, 5985286, 5942130, 5899019, 5855956, 5812941,
    5769976, 5727064, 5684205, 5641401, 5598654, 5555966, 5513337, 5470771, 5428267, 5385828, 5343455, 5301150, 5258915, 5216751,
    5174660, 5132642, 5090701, 5048837, 5007052, 4965347, 4923725, 4882186, 4840732, 4799365, 4758086, 4716897, 4675799, 4634794,
    4593884, 4553070, 4512353, 4471734, 4431217, 4390801, 4350489, 4310282, 4270182, 4230189, 4190306, 4150534, 4110875, 4071329,
    4031899, 3992586, 3953391, 3914317, 3875363, 3836532, 3797826, 3759245, 3720791, 3682466, 3644271, 3606207, 3568276, 3530479,
    3492818, 3455294, 3417908, 3380662, 3343558, 3306596, 3269778, 3233106, 3196580, 3160203, 3123975, 3087897, 3051972, 3016201,
    2980584, 2945124, 2909821, 2874677, 2839693, 2804870, 2770211, 2735715, 2701385, 2667221, 2633225, 2599399, 2565743, 2532258,
    2498947, 2465810, 2432848, 2400062, 2367455, 2335027, 2302779, 2270713, 2238829, 2207129, 2175614, 2144286, 2113145, 2082193,
    2051430, 2020858, 1990479, 1960292, 1930300, 1900503, 1870903, 1841501, 1812297, 1783293, 1754490, 1725889, 1697491, 1669297,
    1641309, 1613526, 1585951, 1558584, 1531427, 1504480, 1477744, 1451221, 1424910, 1398815, 1372934, 1347270, 1321823, 1296594,
    1271584, 1246794, 1222225, 1197878, 1173754, 1149854, 1126178, 1102728, 1079504, 1056507, 1033738, 1011198, 988888, 966809,
    944961, 923345, 901962, 880814, 859899, 839221, 818778, 798572, 778604, 758875, 739385, 720134, 701125, 682356,
    663830, 645546, 627506, 609710, 592159, 574853, 557793, 540980, 524414, 508097, 492027, 476207, 460637, 445317,
    430248, 415430, 400865, 386552, 372492, 358686, 345134, 331836, 318794, 306007, 293477, 281203, 269186, 257426,
    245925, 234681, 223697, 212972, 202506, 192300, 182355, 172671, 163247, 154085, 145185, 136547, 128171, 120058,
    112208, 104622, 97299, 90240, 83445, 76915, 70649, 64648, 58913, 53442, 48238, 43299, 38625, 34218,
    30078, 26203, 22596, 19255, 16180, 13373, 10833, 8560, 6554, 4815, 3344, 2140, 1204, 535,
    134, 0, 134, 535, 1204, 2140, 3344, 4815, 6554, 8560, 10833, 13373, 16180, 19255,
    22596, 26203, 30078, 34218, 38625, 43299, 48238, 53442, 58913, 64648, 70649, 76915, 83445, 90240,
    97299, 104622, 112208, 120058, 128171, 136547, 145185, 154085, 163247, 172671, 182355, 192300, 202506, 212972,
    223697, 234681, 245925, 257426, 269186, 281203, 293477, 306007, 318794, 331836, 345134, 358686, 372492, 386552,
    400865, 415430, 430248, 445317, 460637, 476207, 492027, 508097, 524414, 540980, 557793, 574853, 592159, 609710,
    627506, 645546, 663830, 682356, 701125, 720134, 739385, 758875, 778604, 798572, 818778, 839221, 859899, 880814,
    901962, 923345, 944961, 966809, 988888, 1011198, 1033738, 1056507, 1079504, 1102728, 1126178, 1149854, 1173754, 1197878,
    1222225, 1246794, 1271584, 1296594, 1321823, 1347270, 1372934, 1398815, 1424910, 1451221, 1477744, 1504480, 1531427, 1558584,
    1585951, 1613526, 1641309, 1669297, 1697491, 1725889, 1754490, 1783293, 1812297, 1841501, 1870903, 1900503, 1930300, 1960292,
    1990479, 2020858, 2051430, 2082193, 2113145, 2144286, 2175614, 2207129, 2238829, 2270713, 2302779, 2335027, 2367455, 2400062,
    2432848, 2465810, 2498947, 2532258, 2565743, 2599399, 2633225, 2667221, 2701385, 2735715, 2770211, 2804870, 2839693, 2874677,
    2909821, 2945124, 2980584, 3016201, 3051972, 3087897, 3123975, 3160203, 3196580, 3233106, 3269778, 3306596, 3343558, 3380662,
    3417908, 3455294, 3492818, 3530479, 3568276, 3606207, 3644271, 3682466, 3720791, 3759245, 3797826, 3836532, 3875363, 3914317,
    3953391, 3992586, 4031899, 4071329, 4110875, 4150534, 4190306, 4230189, 4270182, 4310282, 4350489, 4390801, 4431217, 4471734,
    4512353, 4553070, 4593884, 4634794, 4675799, 4716897, 4758086, 4799365, 4840732, 4882186, 4923725, 4965347, 5007052, 5048837,
    5090701, 5132642, 5174660, 5216751, 5258915, 5301150, 5343455, 5385828, 5428267, 5470771, 5513337, 5555966, 5598654, 5641401,
    5684205, 5727064, 5769976, 5812941, 5855956, 5899019, 5942130, 5985286, 6028487, 6071729, 6115013, 6158335, 6201695, 6245091,
    6288521, 6331984, 6375478, 6419001, 6462552, 6506129, 6549730, 6593354, 6637000, 6680665, 6724348, 6768048, 6811762, 6855489,
    6899228, 6942976, 6986733, 7030496, 7074265, 7118036, 7161809,
};

// 获取正弦波表中的值
int get_sine_value(int index) {
    return sine_table[index % TABLE_SIZE];
}

// 用于显示在HEX显示器上的函数
void HEX_PS2(char b1, char b2, char b3) {
    volatile int * HEX3_HEX0_ptr = (int *)HEX3_HEX0_BASE;
    volatile int * HEX5_HEX4_ptr = (int *)HEX5_HEX4_BASE;

    unsigned char seven_seg_decode_table[] = {
        0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07,
        0x7F, 0x67, 0x77, 0x7C, 0x39, 0x5E, 0x79, 0x71
    };

    unsigned char hex_segs[] = {0, 0, 0, 0, 0, 0};
    unsigned int shift_buffer, nibble;
    unsigned char code;
    int i;

    shift_buffer = (b1 << 16) | (b2 << 8) | b3;
    for (i = 0; i < 6; ++i) {
        nibble = shift_buffer & 0x0000000F;
        code = seven_seg_decode_table[nibble];
        hex_segs[i] = code;
        shift_buffer = shift_buffer >> 4;
    }

    *(HEX3_HEX0_ptr) = *(int *)(hex_segs);
    *(HEX5_HEX4_ptr) = *(int *)(hex_segs + 4);
}

int main(void) {
    struct audio_t *const audiop = (struct audio_t *) AUDIO_BASE;
    struct timer_t *const timerp = (struct timer_t *) TIMER_BASE;
    volatile int * PS2_ptr = (int *)PS2_BASE;
    
    int PS2_data, RVALID;
    char byte1 = 0, byte2 = 0, byte3 = 0;
    
    // 初始化PS2键盘
    *(PS2_ptr) = 0xFF;
    
    // 固定的4个最高音调周期值数组（较小的周期值对应较高的音调）
    const int tone_periods[4] = {10, 20, 30, 40};
    int period_in_samples = tone_periods[0];
    int phase_index = 0;
    int phase_step = 1;
    
    // 定义难度级别的持续时间和暂停时间 (以计时器触发次数计)
    const int difficulty_play_time[4] = {4, 2, 2, 2};   // 各难度级别的播放持续触发次数
    const int difficulty_pause_time[4] = {2, 2, 1, 0};  // 各难度级别的暂停持续触发次数
    int difficulty = 0;                                  // 当前难度级别 (0-3)
    int timer_count = 0;                                 // 计时器触发计数
    int play_state = 1;                                  // 1=播放，0=暂停
    
    int is_playing = 0;                                  // 总体播放状态
    unsigned int current_timer_value;
    
    // 设置计时器，每0.25秒触发一次（以便更细粒度地控制各难度级别的时间）
    // 假设时钟频率为50MHz
    timerp->periodl = 0xFFFF;
    timerp->periodh = 0x05F5;  // 约12,500,000周期 = 0.25秒
    timerp->control = 0x7;     // 启动计时器，连续模式，启用中断

    // 用于键盘扫描码处理
    int space_pressed = 0;
    int up_pressed = 0;
    int down_pressed = 0;
    
    while (1) {
        // 读取PS2键盘数据
        PS2_data = *(PS2_ptr);
        RVALID = PS2_data & 0x8000;
        
        if (RVALID) {
            byte1 = byte2;
            byte2 = byte3;
            byte3 = PS2_data & 0xFF;
            
            // 显示PS2数据到HEX显示器
            HEX_PS2(byte1, byte2, byte3);
            
            // 检测键盘事件
            // 按键按下序列通常是: F0(断开码) 后跟键的扫描码
            // 按键释放序列通常是: 键的扫描码
            
            // 空格键控制播放/暂停
            if (byte3 == PS2_KEY_SPACE && byte2 != 0xF0) {
                space_pressed = 1;
            } else if (byte3 == PS2_KEY_SPACE && byte2 == 0xF0) {
                if (space_pressed) {
                    // 空格键释放，切换播放状态
                    is_playing = !is_playing;
                    play_state = 1;  // 重置为播放状态
                    timer_count = 0; // 重置计时器计数
                    space_pressed = 0;
                }
            }
            
            // 上箭头增加难度
            if (byte3 == PS2_KEY_UP && byte2 != 0xF0) {
                up_pressed = 1;
            } else if (byte3 == PS2_KEY_UP && byte2 == 0xF0) {
                if (up_pressed) {
                    // 上箭头释放，增加难度
                    if (difficulty < 3) {
                        difficulty++;
                    }
                    up_pressed = 0;
                }
            }
            
            // 下箭头减少难度
            if (byte3 == PS2_KEY_DOWN && byte2 != 0xF0) {
                down_pressed = 1;
            } else if (byte3 == PS2_KEY_DOWN && byte2 == 0xF0) {
                if (down_pressed) {
                    // 下箭头释放，减少难度
                    if (difficulty > 0) {
                        difficulty--;
                    }
                    down_pressed = 0;
                }
            }
            
            // PS2键盘自动发送的0xAA 0x00序列表示键盘已就绪
            if ((byte2 == (char)0xAA) && (byte3 == (char)0x00)) {
                *(PS2_ptr) = 0xF4;  // 发送启用键盘命令
            }
        }
        
        // 读取当前计时器值
        current_timer_value = timerp->snapl;
        
        // 检查是否计时器触发
        if ((timerp->status & 0x1) != 0) {
            // 清除计时器中断标志
            timerp->status = 0x1;
            
            if (is_playing) {
                timer_count++;
                
                // 根据当前状态和难度级别确定是否需要切换状态
                if (play_state) {
                    // 当前是播放状态
                    if (timer_count >= difficulty_play_time[difficulty]) {
                        // 播放时间结束，切换到暂停状态
                        play_state = 0;
                        timer_count = 0;
                        
                        // 最高难度没有暂停
                        if (difficulty == 3) {
                            // 直接选择新音调并保持播放状态
                            int random_index = rand() % 4;
                            period_in_samples = tone_periods[random_index];
                            phase_step = TABLE_SIZE / period_in_samples;
                            play_state = 1;
                        }
                    }
                } else {
                    // 当前是暂停状态
                    if (timer_count >= difficulty_pause_time[difficulty]) {
                        // 暂停时间结束，切换到播放状态
                        play_state = 1;
                        timer_count = 0;
                        
                        // 选择新的音调
                        int random_index = rand() % 4;
                        period_in_samples = tone_periods[random_index];
                        phase_step = TABLE_SIZE / period_in_samples;
                    }
                }
            }
        }
        
        // 生成音频数据
        if (is_playing && play_state) {
            if ((audiop->wsrc > 0) && (audiop->wslc > 0)) {
                int sample_value = get_sine_value(phase_index);
                audiop->ldata = sample_value;
                audiop->rdata = sample_value;
                
                phase_index += phase_step;
                if (phase_index >= TABLE_SIZE)
                    phase_index -= TABLE_SIZE;
            }
        } else {
            if ((audiop->wsrc > 0) && (audiop->wslc > 0)) {
                audiop->ldata = 0;
                audiop->rdata = 0;
                phase_index = 0;
            }
        }
    }
    
    return 0;
}