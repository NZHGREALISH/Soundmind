#include <stdio.h>

#define AUDIO_BASE 0xFF203040   // Audio core base address
#define SW_BASE    0xFF200040   // Switch base address
#define TIMER_BASE 0xFF202000   // Timer base address

#define TABLE_SIZE 256          // 正弦波查找表大小
#define MAX_AMPLITUDE 0x7FFFFF  // 24-bit 最大振幅
struct audio_t {
    volatile unsigned int control;
    volatile unsigned char rarc;
    volatile unsigned char ralc;
    volatile unsigned char wsrc;
    volatile unsigned char wslc;
    volatile unsigned int ldata;
    volatile unsigned int rdata;
};

// 预计算的正弦波查找表（256 采样点）
const int sine_table[TABLE_SIZE] = {
    4144304, 4246010, 4347655, 4449177, 4550516, 4651610, 4752399, 4852821, 4952817, 5052326,
    5151287, 5249642, 5347331, 5444296, 5540477, 5635818, 5730260, 5823746, 5916222, 6007629,
    6097915, 6187023, 6274901, 6361496, 6446755, 6530627, 6613062, 6694010, 6773422, 6851250,
    6927448, 7001969, 7074769, 7145803, 7215030, 7282407, 7347893, 7411450, 7473039, 7532623,
    7590166, 7645633, 7698991, 7750208, 7799253, 7846096, 7890709, 7933066, 7973141, 8010909,
    8046348, 8079436, 8110155, 8138484, 8164407, 8187909, 8208975, 8227593, 8243751, 8257440,
    8268651, 8277378, 8283615, 8287359, 8288607, 8287359, 8283615, 8277378, 8268651, 8257440,
    8243751, 8227593, 8208975, 8187909, 8164407, 8138484, 8110155, 8079436, 8046348, 8010909,
    7973141, 7933066, 7890709, 7846096, 7799253, 7750208, 7698991, 7645633, 7590166, 7532623,
    7473039, 7411450, 7347893, 7282407, 7215030, 7145803, 7074769, 7001969, 6927448, 6851250,
    6773422, 6694010, 6613062, 6530627, 6446755, 6361496, 6274901, 6187023, 6097915, 6007629,
    5916222, 5823746, 5730260, 5635818, 5540477, 5444296, 5347331, 5249642, 5151287, 5052326,
    4952817, 4852821, 4752399, 4651610, 4550516, 4449177, 4347655, 4246010, 4144304, 4042597,
    3940952, 3839430, 3738091, 3636997, 3536208, 3435786, 3335790, 3236281, 3137320, 3038965,
    2941276, 2844311, 2748130, 2652789, 2558347, 2464861, 2372385, 2280978, 2190692, 2101584,
    2013706, 1927111, 1841852, 1757980, 1675545, 1594597, 1515185, 1437357, 1361159, 1286638,
    1213838, 1142804, 1073577, 1006200, 940714, 877157, 815568, 755984, 698441, 642974,
    589616, 538399, 489354, 442511, 397898, 355541, 315466, 277698, 242259, 209171,
    178452, 150123, 124200, 100698, 79632, 61014, 44856, 31167, 19956, 11229,
    4992, 1248, 0, 1248, 4992, 11229, 19956, 31167, 44856, 61014,
    79632, 100698, 124200, 150123, 178452, 209171, 242259, 277698, 315466, 355541,
    397898, 442511, 489354, 538399, 589616, 642974, 698441, 755984, 815568, 877157,
    940714, 1006200, 1073577, 1142804, 1213838, 1286638, 1361159, 1437357, 1515185, 1594597,
    1675545, 1757980, 1841852, 1927111, 2013706, 2101584, 2190692, 2280978, 2372385, 2464861,
    2558347, 2652789, 2748130, 2844311, 2941276, 3038965, 3137320, 3236281, 3335790, 3435786,
    3536208, 3636997, 3738091, 3839430, 3940952, 4042597, 4144303
};

// 获取正弦波表中的值
int get_sine_value(int index) {
    return sine_table[index % TABLE_SIZE];
}

int main(void) {
    struct audio_t *const audiop = (struct audio_t *) AUDIO_BASE;
    volatile unsigned int *const swp = (volatile unsigned int *) SW_BASE;
    
    int sw_val;
    int period_in_samples;
    int phase_index = 0;
    int phase_step = 1;
    int is_playing = 0;
    int last_sw_val = -1;

    while (1) {
        sw_val = (*swp) & 0x3FF;

        if (sw_val != last_sw_val) {
            last_sw_val = sw_val;
            is_playing = 1;
        }

        if (is_playing) {
            period_in_samples = 80 - ((76 * sw_val) / 1023);
            if (period_in_samples < 4)
                period_in_samples = 4;

            phase_step = TABLE_SIZE / period_in_samples;

            if ((audiop->wsrc > 0) && (audiop->wslc > 0)) {
                int sample_value = get_sine_value(phase_index);
                audiop->ldata = sample_value;
                audiop->rdata = sample_value;
                
                phase_index += phase_step;
                if (phase_index >= TABLE_SIZE)
                    phase_index -= TABLE_SIZE;
            }
        } else {
            if ((audiop->wsrc > 0) && (audiop->wslc > 0)) {
                audiop->ldata = 0;
                audiop->rdata = 0;
                phase_index = 0;
            }
        }
    }

    return 0;
}
